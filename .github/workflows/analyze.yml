
name: Generate Report

on:
  issues:
    types: [opened]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: |
          npm init -y
          npm install @lhci/cli@0.13.x cheerio linkinator node-fetch@3

      - name: Extract URL from issue
        id: extract
        run: |
          url=$(jq -r '.issue.body' $GITHUB_EVENT_PATH | grep -oP 'https?://\S+')
          echo "url=$url" >> $GITHUB_ENV
          echo "URL detected: $url"

      - name: Create output folder
        run: |
          mkdir -p reports/$GITHUB_RUN_ID

      - name: Run Lighthouse
        run: |
          npx @lhci/cli collect \
            --url "$URL" \
            --numberOfRuns=1 \
            --outputDir="reports/$GITHUB_RUN_ID/lh" \
            --report=html,json \
            --settings.chromePath=$(which chrome)

      - name: Scrape SEO elements
        run: |
          node << 'EOF'
          import fetch from 'node-fetch';
          import fs from 'fs';
          import cheerio from 'cheerio';

          const url = process.env.URL;
          const res = await fetch(url);
          const html = await res.text();
          const $ = cheerio.load(html);

          const data = {
            title: $('title').text(),
            metaDesc: $('meta[name="description"]').attr('content') || '',
            h1: $('h1').first().text(),
          };

          fs.writeFileSync(`reports/${process.env.GITHUB_RUN_ID}/seo.json`, JSON.stringify(data, null, 2));
          EOF

      - name: Check broken links
        run: |
          node << 'EOF'
          import { LinkChecker } from 'linkinator';
          import fs from 'fs';

          const checker = new LinkChecker();
          const results = await checker.check({ path: process.env.URL, recurse: false });
          const broken = results.links.filter(l => l.state === 'BROKEN');
          fs.writeFileSync(
            `reports/${process.env.GITHUB_RUN_ID}/links.json`,
            JSON.stringify(broken, null, 2)
          );
          EOF

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ github.run_id }}
          path: reports/${{ github.run_id }}

      - name: Comment back with link
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "Report ready! Download artifacts here: https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
