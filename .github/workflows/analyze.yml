
name: Generate Report

on:
  issues:
    types: [opened]

# مهم: نسمح للـ workflow يكتب تعليق على الـ Issues ويرفع Artifacts
permissions:
  contents: write
  issues: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      # هنكتفي بالحزم دي. هنستخدم fetch المدمج في Node 20 (بدون node-fetch).
      - name: Install dependencies
        run: |
          npm init -y
          npm install @lhci/cli@0.13.x cheerio linkinator

      # نستخرج الرابط من عنوان أو متن الـ Issue ونخزّنه كـ URL في GITHUB_ENV
      - name: Extract URL from issue (title/body)
        id: extract
        run: |
          TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          URL=$(echo "$TITLE" | grep -oE 'https?://[^ ]+' || true)
          if [ -z "$URL" ]; then
            URL=$(echo "$BODY" | grep -oE 'https?://[^ ]+' | head -n1 || true)
          fi
          if [ -z "$URL" ]; then
            echo "❌ لم يتم العثور على URL داخل الـ Issue."
            exit 1
          fi
          echo "URL=$URL" >> $GITHUB_ENV
          echo "✅ Using URL: $URL"

      - name: Create output folder
        run: mkdir -p reports/$GITHUB_RUN_ID

      - name: Run Lighthouse
        env:
          URL: ${{ env.URL }}
        run: |
          echo "Running Lighthouse for $URL"
          npx @lhci/cli collect \
            --url "$URL" \
            --numberOfRuns=1 \
            --outputDir="reports/$GITHUB_RUN_ID/lh" \
            --report=html,json \
            --settings.chromePath="$(which chrome)" \
            --settings.chromeFlags="--headless=new --no-sandbox --disable-gpu"

      - name: Scrape SEO elements (ESM)
        env:
          URL: ${{ env.URL }}
        run: |
          node --input-type=module << 'EOF'
          import { writeFileSync } from 'fs';
          import { load } from 'cheerio';

          const url = process.env.URL;
          const res = await fetch(url, { headers: { 'User-Agent': 'SEO-Auditor/1.0' }});
          const html = await res.text();
          const $ = load(html);

          const data = {
            url,
            title: $('title').text() || '',
            metaDesc: $('meta[name="description"]').attr('content') || '',
            h1: $('h1').first().text() || '',
            canonical: $('link[rel="canonical"]').attr('href') || '',
            robots: $('meta[name="robots"]').attr('content') || ''
          };

          writeFileSync(`reports/${process.env.GITHUB_RUN_ID}/seo.json`, JSON.stringify(data, null, 2));
          EOF

      - name: Check broken links (ESM)
        env:
          URL: ${{ env.URL }}
        run: |
          node --input-type=module << 'EOF'
          import linkinator from 'linkinator';
          import { writeFileSync } from 'fs';

          const { LinkChecker } = linkinator;
          const checker = new LinkChecker();
          const results = await checker.check({
            path: process.env.URL,
            recurse: false,
            timeout: 15000
          });

          const broken = results.links
            .filter(l => l.state === 'BROKEN')
            .map(l => ({ url: l.url, status: l.status }));

          writeFileSync(`reports/${process.env.GITHUB_RUN_ID}/links.json`, JSON.stringify({
            scanned: results.links.length,
            brokenCount: broken.length,
            broken
          }, null, 2));
          EOF

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ github.run_id }}
          path: reports/${{ github.run_id }}

      # نعلّق باستخدام REST API مباشرة علشان نضمن الصلاحيات تشتغل
      - name: Comment back with link (REST)
        env:
          RUN_ID: ${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          API="https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments"
          BODY=$(cat <<EOF
          {
            "body": "✅ Report ready! Download artifacts:\nhttps://github.com/$REPO/actions/runs/$RUN_ID"
          }
          EOF
          )
          curl -s -f -X POST "$API" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$BODY"
